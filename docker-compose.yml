# ═══════════════════════════════════════════════════════════════════════════════
# DOCKER COMPOSE - Plateforme R&D Béton IA (VERSION OPTIMISÉE)
# Services: web (Streamlit) + db (PostgreSQL) + pgadmin (optionnel)
# Auteur: Stage R&D - IMT Nord Europe
# Version: 2.0.0
# ═══════════════════════════════════════════════════════════════════════════════

version: '3.8'

services:
  # ═══════════════════════════════════════════════════════════════════════════
  # APPLICATION STREAMLIT
  # ═══════════════════════════════════════════════════════════════════════════
  web:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: concrete_ai_app
    ports:
      - "8501:8501"
    environment:
      # Database
      - DATABASE_URL=postgresql://app_beton:Passer123@db:5432/concrete_ai_platform
      # Python
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      # Streamlit
      - STREAMLIT_SERVER_HEADLESS=true
      - STREAMLIT_BROWSER_GATHER_USAGE_STATS=false
    volumes:
      # Modèles ML (lecture seule)
      - ./ml_models:/app/ml_models:ro
      # Logs (lecture/écriture)
      - ./logs:/app/logs
      # Config Streamlit custom (optionnel)
      - ./.streamlit:/app/.streamlit:ro
    depends_on:
      db:
        condition: service_healthy
    networks:
      - concrete_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 512M

  # ═══════════════════════════════════════════════════════════════════════════
  # BASE DE DONNÉES POSTGRESQL
  # ═══════════════════════════════════════════════════════════════════════════
  db:
    image: postgres:15-alpine
    container_name: concrete_ai_db
    environment:
      - POSTGRES_USER=app_beton
      - POSTGRES_PASSWORD=Passer123
      - POSTGRES_DB=concrete_ai_platform
      - PGDATA=/var/lib/postgresql/data/pgdata
      # Optimisations PostgreSQL
      - POSTGRES_INITDB_ARGS=--encoding=UTF8 --locale=C
    volumes:
      # Persistance données
      - postgres_data:/var/lib/postgresql/data
      # Script initialisation (si nécessaire)
      - ./database/init.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
      # Backup automatique (optionnel)
      - ./backups:/backups
    ports:
      - "5432:5432"
    networks:
      - concrete_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U app_beton -d concrete_ai_platform"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M

  # ═══════════════════════════════════════════════════════════════════════════
  # PGADMIN (OPTIONNEL - Interface admin PostgreSQL)
  # ═══════════════════════════════════════════════════════════════════════════
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: concrete_ai_pgadmin
    environment:
      - PGADMIN_DEFAULT_EMAIL=admin@imt-nord-europe.fr
      - PGADMIN_DEFAULT_PASSWORD=AdminPass123
      - PGADMIN_CONFIG_SERVER_MODE=False
    ports:
      - "5050:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      - db
    networks:
      - concrete_network
    restart: unless-stopped
    profiles:
      - admin  # Démarrer seulement si profil "admin" activé

# ═══════════════════════════════════════════════════════════════════════════════
# VOLUMES
# ═══════════════════════════════════════════════════════════════════════════════
volumes:
  postgres_data:
    driver: local
    name: concrete_ai_postgres_data
    labels:
      com.imt.description: "Données PostgreSQL de la plateforme Béton IA"
  
  pgadmin_data:
    driver: local
    name: concrete_ai_pgadmin_data

# ═══════════════════════════════════════════════════════════════════════════════
# RÉSEAU
# ═══════════════════════════════════════════════════════════════════════════════
networks:
  concrete_network:
    driver: bridge
    name: concrete_ai_network
    labels:
      com.imt.description: "Réseau isolé plateforme Béton IA"

# ═══════════════════════════════════════════════════════════════════════════════
# COMMANDES UTILES
# ═══════════════════════════════════════════════════════════════════════════════
#
# ┌─────────────────────────────────────────────────────────────────────────────┐
# │ DÉMARRAGE                                                                   │
# └─────────────────────────────────────────────────────────────────────────────┘
#
# Démarrer tous les services:
#   docker-compose up -d
#
# Démarrer avec PgAdmin:
#   docker-compose --profile admin up -d
#
# Build et démarrer:
#   docker-compose up -d --build
#
# ┌─────────────────────────────────────────────────────────────────────────────┐
# │ LOGS & MONITORING                                                           │
# └─────────────────────────────────────────────────────────────────────────────┘
#
# Voir logs de tous les services:
#   docker-compose logs -f
#
# Logs d'un service spécifique:
#   docker-compose logs -f web
#   docker-compose logs -f db
#
# État des services:
#   docker-compose ps
#
# Stats ressources:
#   docker stats concrete_ai_app concrete_ai_db
#
# ┌─────────────────────────────────────────────────────────────────────────────┐
# │ GESTION                                                                     │
# └─────────────────────────────────────────────────────────────────────────────┘
#
# Arrêter (sans supprimer):
#   docker-compose stop
#
# Arrêter et supprimer conteneurs:
#   docker-compose down
#
# Arrêter et supprimer TOUT (⚠️ PERTE DONNÉES):
#   docker-compose down -v
#
# Redémarrer un service:
#   docker-compose restart web
#
# ┌─────────────────────────────────────────────────────────────────────────────┐
# │ SHELL & DEBUG                                                               │
# └─────────────────────────────────────────────────────────────────────────────┘
#
# Shell dans app:
#   docker exec -it concrete_ai_app bash
#
# Shell PostgreSQL:
#   docker exec -it concrete_ai_db psql -U app_beton -d concrete_ai_platform
#
# Inspecter réseau:
#   docker network inspect concrete_ai_network
#
# ┌─────────────────────────────────────────────────────────────────────────────┐
# │ BACKUP & RESTORE                                                            │
# └─────────────────────────────────────────────────────────────────────────────┘
#
# Backup base de données:
#   docker exec concrete_ai_db pg_dump -U app_beton concrete_ai_platform > backup_$(date +%Y%m%d).sql
#
# Restore:
#   docker exec -i concrete_ai_db psql -U app_beton concrete_ai_platform < backup_20260214.sql
#
# ═══════════════════════════════════════════════════════════════════════════════
# ACCÈS
# ═══════════════════════════════════════════════════════════════════════════════
#
# Application web:      http://localhost:8501
# PostgreSQL:           localhost:5432
# PgAdmin (si activé):  http://localhost:5050
#
# Credentials PostgreSQL:
#   - User:     app_beton
#   - Password: Passer123
#   - Database: concrete_ai_platform
#
# Credentials PgAdmin:
#   - Email:    admin@imt-nord-europe.fr
#   - Password: AdminPass123
#
# ═══════════════════════════════════════════════════════════════════════════════